{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-shield-alt"></i> All medical records are protected with AES-256 encryption and are only decrypted when you view them.
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-3">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Medical Records</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action active" data-type="all">All Records</a>
                    <a href="#" class="list-group-item list-group-item-action" data-type="medical_visit">Medical Visits</a>
                    <a href="#" class="list-group-item list-group-item-action" data-type="lab_result">Lab Results</a>
                    <a href="#" class="list-group-item list-group-item-action" data-type="prescription">Prescriptions</a>
                    <a href="#" class="list-group-item list-group-item-action" data-type="vaccination">Vaccinations</a>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Add New Record</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success btn-block w-100" data-bs-toggle="modal" data-bs-target="#addRecordModal">
                        <i class="fas fa-plus-circle"></i> Add Medical Record
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0" id="recordsTitle">Medical Records</h4>
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" placeholder="Search records..." id="searchRecords">
                        <button class="btn btn-light" type="button" id="searchButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Provider</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p>Decrypting medical records...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Encrypted with AES-256</small>
                        <nav aria-label="Medical records pagination">
                            <ul class="pagination mb-0" id="recordsPagination">
                                <!-- Pagination will be added dynamically -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Record Modal -->
<div class="modal fade" id="addRecordModal" tabindex="-1" aria-labelledby="addRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addRecordModalLabel">Add New Medical Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRecordForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="recordType" class="form-label">Record Type</label>
                            <select class="form-select" id="recordType" name="recordType" required>
                                <option value="">Select a type</option>
                                <option value="medical_visit">Medical Visit</option>
                                <option value="lab_result">Lab Result</option>
                                <option value="prescription">Prescription</option>
                                <option value="vaccination">Vaccination</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="recordDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="recordDate" name="recordDate" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="providerName" class="form-label">Healthcare Provider</label>
                        <input type="text" class="form-control" id="providerName" name="providerName" placeholder="Doctor or facility name">
                    </div>
                    
                    <div class="mb-3">
                        <label for="recordTitle" class="form-label">Title/Description</label>
                        <input type="text" class="form-control" id="recordTitle" name="recordTitle" required placeholder="Brief description">
                    </div>
                    
                    <div class="mb-3">
                        <label for="recordDetails" class="form-label">Detailed Information</label>
                        <textarea class="form-control" id="recordDetails" name="recordDetails" rows="4" placeholder="Enter detailed information about this medical record"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="recordFile" class="form-label">Attach Document (Optional)</label>
                        <input type="file" class="form-control" id="recordFile" name="recordFile">
                        <small class="form-text text-muted">Upload related documents (PDF, images, etc.)</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="encryptConfirm" required>
                        <label class="form-check-label" for="encryptConfirm">
                            I understand this record will be encrypted with AES-256 before storage
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveRecordBtn">
                    <i class="fas fa-lock"></i> Encrypt & Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Record Modal -->
<div class="modal fade" id="viewRecordModal" tabindex="-1" aria-labelledby="viewRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="viewRecordModalLabel">Medical Record Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewRecordBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Decrypting record data...</p>
                </div>
            </div>
            <div class="modal-footer">
                <span class="me-auto text-muted"><small><i class="fas fa-shield-alt"></i> Encrypted with AES-256</small></span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editRecordBtn">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Load medical records
        function loadMedicalRecords(page = 1, recordType = 'all') {
            $('#recordsTableBody').html('<tr><td colspan="5" class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Decrypting medical records...</p></td></tr>');
            
            $.ajax({
                url: '/api/medical-records',
                type: 'GET',
                data: {
                    page: page,
                    record_type: recordType,
                    search: $('#searchRecords').val()
                },
                success: function(response) {
                    displayMedicalRecords(response);
                    updatePagination(response.pagination);
                },
                error: function(xhr) {
                    $('#recordsTableBody').html('<tr><td colspan="5" class="text-center text-danger">Error loading records. Please try again.</td></tr>');
                }
            });
        }
        
        function displayMedicalRecords(data) {
            if (!data || !data.records || data.records.length === 0) {
                $('#recordsTableBody').html('<tr><td colspan="5" class="text-center">No medical records found</td></tr>');
                return;
            }
            
            let html = '';
            data.records.forEach(record => {
                html += `
                <tr>
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>${formatRecordType(record.type)}</td>
                    <td>${record.provider || 'N/A'}</td>
                    <td>${record.title}</td>
                    <td>
                        <button class="btn btn-sm btn-info view-record" data-id="${record.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-record" data-id="${record.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            $('#recordsTableBody').html(html);
        }
        
        function formatRecordType(type) {
            const types = {
                'medical_visit': 'Medical Visit',
                'lab_result': 'Lab Result',
                'prescription': 'Prescription',
                'vaccination': 'Vaccination',
                'other': 'Other'
            };
            return types[type] || type;
        }
        
        function updatePagination(pagination) {
            if (!pagination) return;
            
            let html = '';
            if (pagination.totalPages > 1) {
                html += `<li class="page-item ${pagination.currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${pagination.currentPage - 1}">Previous</a>
                </li>`;
                
                for (let i = 1; i <= pagination.totalPages; i++) {
                    html += `<li class="page-item ${pagination.currentPage === i ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>`;
                }
                
                html += `<li class="page-item ${pagination.currentPage === pagination.totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${pagination.currentPage + 1}">Next</a>
                </li>`;
            }
            
            $('#recordsPagination').html(html);
        }
        
        // View record details
        $(document).on('click', '.view-record', function() {
            const recordId = $(this).data('id');
            
            $('#viewRecordBody').html('<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Decrypting record data...</p></div>');
            $('#viewRecordModal').modal('show');
            
            $.ajax({
                url: `/api/medical-records/${recordId}`,
                type: 'GET',
                success: function(response) {
                    displayRecordDetails(response.record);
                },
                error: function() {
                    $('#viewRecordBody').html('<div class="alert alert-danger">Error loading record details</div>');
                }
            });
        });
        
        function displayRecordDetails(record) {
            if (!record) {
                $('#viewRecordBody').html('<div class="alert alert-warning">Record not found</div>');
                return;
            }
            
            let html = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> This data has been securely decrypted for viewing
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Record Type:</h6>
                        <p>${formatRecordType(record.type)}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Date:</h6>
                        <p>${new Date(record.date).toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Provider:</h6>
                    <p>${record.provider || 'Not specified'}</p>
                </div>
                <div class="mb-3">
                    <h6>Title/Description:</h6>
                    <p>${record.title}</p>
                </div>
                <div class="mb-3">
                    <h6>Detailed Information:</h6>
                    <div class="border p-3 bg-light">
                        ${record.details || 'No detailed information provided'}
                    </div>
                </div>`;
                
            if (record.attachments && record.attachments.length > 0) {
                html += `<div class="mb-3">
                    <h6>Attachments:</h6>
                    <ul class="list-group">`;
                
                record.attachments.forEach(file => {
                    html += `<li class="list-group-item">
                        <a href="/api/medical-records/${record.id}/attachment/${file.id}" target="_blank">
                            <i class="fas fa-file"></i> ${file.name}
                        </a>
                    </li>`;
                });
                
                html += `</ul></div>`;
            }
            
            $('#viewRecordBody').html(html);
            $('#editRecordBtn').data('id', record.id);
        }
        
        // Save new record
        $('#saveRecordBtn').click(function() {
            const form = document.getElementById('addRecordForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = new FormData(form);
            
            // Show encryption animation
            $('#saveRecordBtn').html('<i class="fas fa-spinner fa-spin"></i> Encrypting...');
            
            $.ajax({
                url: '/api/medical-records',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    $('#addRecordModal').modal('hide');
                    
                    Swal.fire({
                        title: 'Success!',
                        text: 'Medical record encrypted and saved successfully',
                        icon: 'success'
                    });
                    
                    loadMedicalRecords();
                    form.reset();
                },
                error: function(xhr) {
                    Swal.fire({
                        title: 'Error!',
                        text: xhr.responseJSON ? xhr.responseJSON.error : 'Failed to save record',
                        icon: 'error'
                    });
                },
                complete: function() {
                    $('#saveRecordBtn').html('<i class="fas fa-lock"></i> Encrypt & Save');
                }
            });
        });
        
        // Delete record
        $(document).on('click', '.delete-record', function() {
            const recordId = $(this).data('id');
            
            Swal.fire({
                title: 'Are you sure?',
                text: 'This record will be permanently deleted',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/api/medical-records/${recordId}`,
                        type: 'DELETE',
                        success: function() {
                            Swal.fire(
                                'Deleted!',
                                'Record has been deleted.',
                                'success'
                            );
                            loadMedicalRecords();
                        },
                        error: function() {
                            Swal.fire(
                                'Error!',
                                'Failed to delete record',
                                'error'
                            );
                        }
                    });
                }
            });
        });
        
        // Filter by record type
        $('.list-group-item-action[data-type]').click(function(e) {
            e.preventDefault();
            
            $('.list-group-item-action[data-type]').removeClass('active');
            $(this).addClass('active');
            
            const recordType = $(this).data('type');
            $('#recordsTitle').text($(this).text());
            
            loadMedicalRecords(1, recordType);
        });
        
        // Pagination
        $(document).on('click', '#recordsPagination .page-link', function(e) {
            e.preventDefault();
            
            const page = $(this).data('page');
            const recordType = $('.list-group-item-action[data-type].active').data('type');
            
            loadMedicalRecords(page, recordType);
        });
        
        // Search
        $('#searchButton').click(function() {
            const recordType = $('.list-group-item-action[data-type].active').data('type');
            loadMedicalRecords(1, recordType);
        });
        
        $('#searchRecords').keypress(function(e) {
            if (e.which === 13) {
                const recordType = $('.list-group-item-action[data-type].active').data('type');
                loadMedicalRecords(1, recordType);
            }
        });
        
        // Initialize
        loadMedicalRecords();
    });
</script>
{% endblock %}